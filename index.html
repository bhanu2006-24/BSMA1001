<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Portal | StudyWithUS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- MathJax -->
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8fafc; color: #333; overflow: hidden; }
        :root { --sidebar-w: 280px; --icon-bar-w: 64px; --header-h: 60px; --primary: #7f1d1d; }
        
        .top-bar { height: var(--header-h); background: white; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; px-4; z-index: 50; }
        .icon-bar { width: var(--icon-bar-w); background: #1e293b; height: calc(100vh - var(--header-h)); display: flex; flex-direction: column; align-items: center; padding-top: 1rem; color: #94a3b8; }
        .icon-item { padding: 12px; cursor: pointer; transition: 0.2s; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; }
        .icon-item:hover, .icon-item.active { color: white; background: #334155; }
        
        .nav-sidebar { width: var(--sidebar-w); background: white; border-right: 1px solid #e2e8f0; height: calc(100vh - var(--header-h)); overflow-y: auto; }
        .nav-item { padding: 10px 16px; cursor: pointer; font-size: 0.9rem; border-left: 3px solid transparent; }
        .nav-item:hover { background: #f1f5f9; }
        .nav-item.active { background: #fef2f2; border-left-color: var(--primary); color: var(--primary); font-weight: 500; }
        .nav-group-header { padding: 12px 16px; font-weight: 600; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; color: #475569; }
        .nav-group-header:hover { color: #1e293b; }
        
        .main-content { flex: 1; height: calc(100vh - var(--header-h)); overflow-y: auto; background: white; position: relative; }
        .content-container { max-width: 900px; margin: 0 auto; padding: 40px; }
        
        /* Typography */
        .prose h1 { font-size: 2rem; font-weight: 700; margin-bottom: 1rem; color: #1e293b; }
        .prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #334155; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; color: #475569; }
        .prose a { color: var(--primary); text-decoration: underline; }
        .prose ul { list-style: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        
        /* Quiz */
        .quiz-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
    </style>
     <script type="importmap">
        {
            "imports": {
                "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
            }
        }
    </script>
</head>
<body>

    <div id="app" class="flex flex-col h-screen">
        
        <!-- Header -->
        <header class="top-bar shrink-0 shadow-sm">
            <div class="flex items-center gap-4 pl-2">
                 <div class="w-8 h-8 rounded bg-red-900 text-white flex items-center justify-center font-bold">U</div>
                 <div>
                     <h1 class="font-bold text-gray-900 leading-tight">{{ course.meta.title }}</h1>
                     <p class="text-xs text-gray-500">{{ course.meta.subtitle }}</p>
                 </div>
            </div>
            <div class="flex gap-4 pr-4">
                <button class="text-gray-500 hover:text-gray-900"><i class="fa-regular fa-user"></i></button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Icon Sidebar -->
            <div class="icon-bar shrink-0">
                <div class="icon-item active"><i class="fa-solid fa-layer-group text-xl"></i><span>Content</span></div>
                <div class="icon-item"><i class="fa-solid fa-chart-pie text-xl"></i><span>Grades</span></div>
                <div class="icon-item"><i class="fa-solid fa-message text-xl"></i><span>Discuss</span></div>
            </div>

            <!-- Nav Sidebar -->
            <nav class="nav-sidebar shrink-0">
                <div v-for="sec in course.sections" :key="sec.id">
                    <div @click="toggleSec(sec)" class="nav-group-header">
                        <span class="truncate">{{ sec.title }}</span>
                        <i class="fa-solid fa-chevron-down text-xs transition" :class="{ '-rotate-90': !sec.isOpen }"></i>
                    </div>
                    
                    <div v-if="sec.isOpen" class="bg-gray-50/50 pb-2">
                         <!-- If Generic Section (Text/Calendar/Compiler) -->
                         <div v-if="['text','compiler','calendar','faq'].includes(sec.type)" 
                              @click="select(sec, null)" 
                              :class="['nav-item flex items-center gap-2', (activeSec === sec && !activeItem) ? 'active' : '']">
                              <i :class="getIcon(sec.type)"></i>
                              <span>Overview</span>
                         </div>
                         
                         <!-- If Module -->
                         <div v-if="sec.items">
                             <div v-for="(item, idx) in sec.items" :key="idx"
                                  @click="select(sec, item)"
                                  :class="['nav-item pl-8 flex items-center gap-2', activeItem === item ? 'active' : '']">
                                  <i :class="getIcon(item.type)"></i>
                                  <span class="truncate text-sm">{{ item.title }}</span>
                             </div>
                         </div>
                    </div>
                </div>
            </nav>

            <!-- Main Stage -->
            <main class="main-content">
                <div class="content-container">
                    
                    <!-- BREADCRUMB -->
                    <div class="mb-6 flex items-center gap-2 text-sm text-gray-500">
                        <span>{{ activeSec ? activeSec.title : 'Home' }}</span>
                        <i class="fa-solid fa-chevron-right text-[10px]"></i>
                        <span class="font-bold text-gray-800">{{ activeItem ? activeItem.title : 'Overview' }}</span>
                    </div>

                    <!-- 1. TEXT / MD CONTENT -->
                    <div v-if="currentViewType === 'text'" class="animate-fade-in">
                         <div class="prose max-w-none" v-html="renderMd(currentContent)"></div>
                    </div>

                    <!-- 2. VIDEO PLAYER -->
                    <div v-else-if="currentViewType === 'video'" class="animate-fade-in">
                        <div class="aspect-video bg-black rounded-lg overflow-hidden shadow-lg mb-6">
                            <!-- Local Video if path contains dot, else YouTube Embed -->
                            <video v-if="isLocalMedia(activeItem.url)" :src="activeItem.url" controls class="w-full h-full"></video>
                            <iframe v-else :src="getEmbedUrl(activeItem.url)" class="w-full h-full" frameborder="0" allowfullscreen></iframe>
                        </div>
                         <h2 class="text-2xl font-bold mb-2">{{ activeItem.title }}</h2>
                         <p class="text-gray-600">Video source: {{ activeItem.url }}</p>
                    </div>

                    <!-- 3. PDF VIEWER -->
                    <div v-else-if="currentViewType === 'pdf'" class="animate-fade-in h-[80vh]">
                         <object :data="activeItem.url" type="application/pdf" class="w-full h-full rounded-lg border border-gray-200">
                             <p>Your browser does not support PDFs. <a :href="activeItem.url">Download</a></p>
                         </object>
                    </div>

                    <!-- 4. QUIZ ENGINE -->
                    <div v-else-if="currentViewType === 'quiz'" class="animate-fade-in max-w-3xl">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                            <strong>Practice Quiz:</strong> This assessment is for self-evaluation.
                        </div>
                        
                        <div v-if="activeItem.questions && activeItem.questions.length">
                            <div v-for="(q, qIdx) in activeItem.questions" :key="qIdx" class="quiz-card group">
                                <div class="flex gap-2 mb-4">
                                    <span class="font-bold text-gray-400 select-none">Q{{ qIdx + 1 }}.</span>
                                    <div class="prose prose-sm" v-html="renderMd(q.text)"></div>
                                </div>
                                
                                <!-- MCQ / MSQ -->
                                <div v-if="q.type === 'mcq' || q.type === 'msq'" class="space-y-2 pl-8">
                                    <label v-for="(opt, oIdx) in q.options" :key="oIdx" class="flex items-start gap-3 p-2 rounded hover:bg-gray-50 cursor-pointer transition border border-transparent hover:border-gray-200">
                                        <input :type="q.type === 'msq' ? 'checkbox' : 'radio'" :name="'q'+qIdx" class="mt-1.5 accent-red-700">
                                        <div class="text-sm text-gray-700 pt-0.5" v-html="renderMd(opt)"></div>
                                    </label>
                                </div>

                                <!-- Boolean -->
                                <div v-if="q.type === 'boolean'" class="flex gap-4 pl-8">
                                    <label class="btn border px-4 py-2 rounded flex gap-2"><input type="radio" :name="'q'+qIdx" value="true"> True</label>
                                    <label class="btn border px-4 py-2 rounded flex gap-2"><input type="radio" :name="'q'+qIdx" value="false"> False</label>
                                </div>
                                
                                <!-- Numeric -->
                                <div v-if="q.type === 'numeric'" class="pl-8">
                                    <input type="number" class="border p-2 rounded w-48 bg-gray-50" placeholder="Enter answer...">
                                </div>

                            </div>
                            <button class="bg-red-800 text-white px-8 py-3 rounded-lg font-bold hover:bg-red-900 shadow-lg">Submit Assignment</button>
                        </div>
                        <div v-else class="text-center py-12 text-gray-400">No questions in this quiz.</div>
                    </div>

                    <!-- 5. COMPILER -->
                    <div v-else-if="currentViewType === 'compiler'" class="content-full h-[70vh] flex flex-col border border-gray-300 rounded-lg overflow-hidden">
                        <div class="bg-gray-100 p-2 flex justify-between items-center border-b border-gray-300">
                            <span class="text-xs font-mono text-gray-600">Ref: {{ activeSec.id }} // {{ activeSec.language }}</span>
                            <button @click="runCode" class="bg-green-600 text-white px-4 py-1 rounded text-xs font-bold flex items-center gap-2 shadow-sm">
                                <i class="fa-solid fa-play"></i> Run Code
                            </button>
                        </div>
                        <textarea v-model="compilerCode" class="flex-1 bg-[#1e1e1e] text-gray-100 p-4 font-mono text-sm leading-relaxed resize-none outline-none"></textarea>
                        <div class="h-32 bg-black text-green-400 p-4 font-mono text-xs overflow-y-auto">
                            <div v-if="compilerOut">{{ compilerOut }}</div>
                            <div v-if="compilerErr" class="text-red-400">{{ compilerErr }}</div>
                            <div v-if="!compilerOut && !compilerErr" class="text-gray-600 italic">// Output ready</div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { createApp } from 'vue';
        import { loadCourse } from './src/services/course_data.js';
        import { renderMarkdown, configureMarkdown } from './src/services/md.js';
        import { CodeCompiler } from './src/services/compiler.js';

        configureMarkdown();
        const compiler = new CodeCompiler();

        createApp({
            data() {
                return {
                    course: { meta: {}, sections: [] },
                    activeSec: null,
                    activeItem: null,
                    compilerCode: '',
                    compilerOut: '',
                    compilerErr: ''
                }
            },
            computed: {
                currentViewType() {
                    if(this.activeItem) return this.activeItem.type;
                    if(this.activeSec) {
                        return this.activeSec.type; 
                    }
                    return 'text';
                },
                currentContent() {
                    if(this.activeItem && this.activeItem.type === 'md') return this.activeItem.content || 'Loading...'; 
                    return this.activeSec ? this.activeSec.content : '';
                }
            },
            watch: {
                // Fetch MD content if item is 'md' type and has a URL
                activeItem: {
                    immediate: true,
                    async handler(val) {
                        if(val && val.type === 'md' && val.url && !val.content) {
                            try {
                                const res = await fetch(val.url);
                                if(res.ok) val.content = await res.text();
                            } catch(e) { console.error(e); }
                        }
                        this.refreshMath();
                    }
                },
                currentContent() {
                    this.refreshMath();
                }
            },
            async mounted() {
                this.course = await loadCourse();
                if(this.course.sections.length > 0) {
                    this.course.sections[0].isOpen = true; // Auto open first
                    this.select(this.course.sections[0], null);
                }
            },
            methods: {
                refreshMath() {
                    this.$nextTick(() => {
                       if(window.MathJax) window.MathJax.typesetPromise();
                    });
                },
                renderMd(t) { return renderMarkdown(t || ''); },
                toggleSec(s) { s.isOpen = !s.isOpen; },
                select(s, i) {
                    this.activeSec = s;
                    this.activeItem = i;
                    if(s.type === 'compiler' && !i) {
                         this.compilerCode = s.starterCode || '';
                         compiler.initPython(); // Preload
                    }
                },
                isLocalMedia(url) {
                    return url && (url.startsWith('./') || url.startsWith('assets/') || !url.includes('http'));
                },
                getEmbedUrl(url) {
                    if(!url) return '';
                    if(url.includes('youtube.com') || url.includes('youtu.be')) {
                        // Basic parser
                        const v = url.split('v=')[1] || url.split('/').pop();
                        return `https://www.youtube.com/embed/${v.split('&')[0]}`;
                    }
                    return url;
                },
                getIcon(type) {
                    const map = { video: 'fa-circle-play', pdf: 'fa-file-pdf', 'md': 'fa-file-lines', quiz: 'fa-list-check', compiler: 'fa-code', text: 'fa-align-left' };
                    return 'fa-regular ' + (map[type] || 'fa-file');
                },
                async runCode() {
                    this.compilerOut = 'Running...';
                    this.compilerErr = '';
                    const r = await compiler.run(this.compilerCode, this.activeSec.language || 'python');
                    this.compilerOut = r.output;
                    this.compilerErr = r.error;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
